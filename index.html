<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BeatRush</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: url('background2.png') center/cover no-repeat fixed;
      margin: 0;
      padding: 10px;
      text-align: center;
    }
    .hidden { display: none; }
    .mode-button {
      padding: 15px;
      margin: 10px auto;
      width: 90%;
      max-width: 300px;
      font-size: 18px;
      border: none;
      border-radius: 15px;
      background: #fff;
      box-shadow: 3px 3px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      font-weight: bold;
      display: block;
    }
    button {
      padding: 10px 16px;
      margin: 6px;
      font-size: 16px;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      background-color: #fff;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }
    .active { background-color: #90ee90; }
    .done::after { content: ' ‚úÖ'; }
    #progress-bar {
      width: 90%;
      max-width: 400px;
      height: 10px;
      background-color: #ccc;
      border-radius: 5px;
      overflow: hidden;
      margin: 20px auto;
    }
    #progress {
      width: 0%;
      height: 100%;
      background-color: #4CAF50;
      transition: width 0.1s linear;
    }
    .player-wrapper {
      position: relative;
      width: 100%;
      max-width: 400px;
      aspect-ratio: 16 / 9;
      margin: 20px auto;
      border-radius: 12px;
      overflow: hidden;
    }
    .player-wrapper iframe {
      width: 100%;
      height: 100%;
      border-radius: 12px;
    }
    .blur-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      border-radius: 12px;
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      pointer-events: none;
      mask-image: linear-gradient(to right, black 0%, black calc(100% - 35px), transparent 100%);
      -webkit-mask-image: linear-gradient(to right, black 0%, black calc(100% - 35px), transparent 100%);
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    .blur-overlay.hidden-blur { opacity: 0; }
    @media (max-width: 500px) {
      body {
        background-size: contain;
        background-position: center top;
      }
      .blur-overlay {
        mask-image: linear-gradient(to right, black 0%, black 80%, transparent 100%);
        -webkit-mask-image: linear-gradient(to right, black 0%, black 80%, transparent 100%);
      }
    }
  </style>
</head>
<body>
  <h1>üé∂ BeatRush üé∂</h1>

  <div id="modeSelection">
    <button class="mode-button" onclick="startRush()">‚ö° Rush Mode</button>
    <button class="mode-button" onclick="startClassic()">üéº Classic Mode</button>
    <button class="mode-button" onclick="startSpotify()">üéµ Spotify Mode</button>
  </div>

  <div id="rushApp" class="hidden">
    <button onclick="goBack()">‚¨ÖÔ∏è Vissza</button>
    <h2>Rush m√≥d</h2>
    <input type="text" id="youtubeLink" placeholder="YouTube/MP3/MP4 link..."/>
    <button onclick="loadVideo()">Bet√∂lt√©s</button>
    <div>
      <h3>0 mp-t≈ël:</h3>
      <button onclick="handlePlay(this, 1, 0)">1 mp</button>
      <button onclick="handlePlay(this, 3, 0)">3 mp</button>
      <button onclick="handlePlay(this, 5, 0)">5 mp</button>
    </div>
    <div>
      <h3>30 mp-t≈ël:</h3>
      <button onclick="handlePlay(this, 1, 30)">1 mp</button>
      <button onclick="handlePlay(this, 3, 30)">3 mp</button>
      <button onclick="handlePlay(this, 5, 30)">5 mp</button>
    </div>
    <div class="player-wrapper"><div id="player"></div></div>
    <audio id="audioPlayer" style="display:none;"></audio>
    <video id="videoPlayer" style="display:none;"></video>
    <div id="progress-bar"><div id="progress"></div></div>
  </div>

  <div id="classicApp" class="hidden">
    <button onclick="goBack()">‚¨ÖÔ∏è Vissza</button>
    <h2>Classic m√≥d</h2>
    <input type="text" id="classicLink" placeholder="MP3/MP4 link..."/>
    <audio id="classicAudio" controls style="display:none; width:90%; margin-top:20px;"></audio>
    <video id="classicVideo" controls style="display:none; width:90%; max-width:400px; margin-top:20px;"></video>
    <div id="progress-bar"><div id="progress"></div></div>
  </div>

  <div id="spotifyApp" class="hidden">
    <button onclick="goBack()">‚¨ÖÔ∏è Vissza</button>
    <h2>Spotify m√≥d</h2>
    <input id="spotifyInput" placeholder="https://open.spotify.com/track/..."/>
    <button onclick="loadSpotifyTrack()">‚ñ∂Ô∏è Lej√°tsz√°s</button>
    <button id="toggleBlurButton" onclick="toggleBlur()">üîç Megold√°s</button>
    <div id="spotifyPlayerWrapper"></div>
  </div>

  <script>
    let player, interval, blurVisible = true;
    let currentSource = 'youtube';

    function showOnly(id) {
      ['modeSelection','rushApp','classicApp','spotifyApp'].forEach(e =>
        document.getElementById(e)?.classList.add('hidden'));
      document.getElementById(id)?.classList.remove('hidden');
    }

    function goBack() {
      stopAllMedia();
      showOnly('modeSelection');
    }

    function startRush() {
      stopAllMedia();
      showOnly('rushApp');
    }

    function startClassic() {
      stopAllMedia();
      showOnly('classicApp');
    }

    function startSpotify() {
      stopAllMedia();
      showOnly('spotifyApp');
    }

    function stopAllMedia() {
      if (player?.stopVideo) player.stopVideo();
      ['audioPlayer','videoPlayer','classicAudio','classicVideo'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.pause(); el.currentTime = 0; }
      });
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '180',
        width: '320',
        videoId: '',
        events: { 'onReady': () => {} }
      });
    }

    function loadVideo() {
      const link = document.getElementById('youtubeLink').value.trim();
      if (link.includes('youtube.com') || link.includes('youtu.be')) {
        currentSource = 'youtube';
        const id = (link.match(/[?&]v=([^&#]*)/) || [])[1] || link.split('/').pop();
        player.loadVideoById(id);
        player.stopVideo();
      } else if (link.endsWith('.mp3')) {
        currentSource = 'audio';
        const ap = document.getElementById('audioPlayer');
        ap.src = link; ap.load();
      } else if (link.endsWith('.mp4')) {
        currentSource = 'video';
        const vp = document.getElementById('videoPlayer');
        vp.src = link; vp.load();
      }
    }

    function handlePlay(btn, seconds, start) {
      btn.classList.add('active');
      btn.disabled = true;
      let count = 0;
      function once() {
        if (count >= 3) {
          btn.classList.remove('active');
          btn.classList.add('done');
          btn.disabled = false;
          return;
        }
        const media = currentSource === 'youtube' ? player :
                      currentSource === 'audio' ? document.getElementById('audioPlayer') :
                      document.getElementById('videoPlayer');
        if (currentSource === 'youtube') {
          player.seekTo(start); player.playVideo();
          setTimeout(() => player.pauseVideo(), seconds * 1000);
        } else {
          media.currentTime = start; media.play();
          setTimeout(() => media.pause(), seconds * 1000);
        }
        animateProgress(seconds);
        count++;
        setTimeout(once, (seconds + 0.7) * 1000);
      }
      once();
    }

    function animateProgress(duration) {
      clearInterval(interval);
      const progress = document.getElementById('progress');
      let width = 0;
      interval = setInterval(() => {
        width += 100 / (duration * 10);
        if (width >= 100) { width = 100; clearInterval(interval); }
        progress.style.width = width + "%";
      }, 100);
    }

    function loadSpotifyTrack() {
      const input = document.getElementById("spotifyInput").value.trim();
      if (!input.includes("/track/")) return alert("√ârv√©nytelen Spotify link.");
      const trackId = input.split("/track/")[1].split("?")[0];
      const embedUrl = `https://open.spotify.com/embed/track/${trackId}?utm_source=generator&autoplay=1`;
      blurVisible = true;
      document.getElementById("toggleBlurButton").textContent = "üîç Megold√°s";
      document.getElementById("spotifyPlayerWrapper").innerHTML = `
        <div class="player-wrapper">
          <iframe src="${embedUrl}" frameborder="0"
            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
            loading="lazy"></iframe>
          <div class="blur-overlay" id="blurLayer"></div>
        </div>`;
    }

    function toggleBlur() {
      const blur = document.getElementById("blurLayer");
      const button = document.getElementById("toggleBlurButton");
      if (blur) {
        blurVisible = !blurVisible;
        blur.classList.toggle("hidden-blur", !blurVisible);
        button.textContent = blurVisible ? "üîç Megold√°s" : "üôà Elrejt√©s";
      }
    }
  </script>
</body>
</html>
