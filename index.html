<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BeatRush - QR k√≥ddal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      text-align: center;
      padding: 20px;
      margin: 0;
    }
    input[type="text"] {
      width: 80%;
      padding: 10px;
      margin: 10px 5px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    .button-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    button {
      padding: 15px 20px;
      border: none;
      border-radius: 15px;
      background: linear-gradient(145deg, #ffffff, #d1d1d1);
      box-shadow: 5px 5px 10px #c1c1c1, -5px -5px 10px #ffffff;
      font-size: 16px;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      box-shadow: inset 5px 5px 10px #c1c1c1, inset -5px -5px 10px #ffffff;
    }
    #qr-button {
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
      margin-bottom: 15px;
    }
    #loadButton {
      background-color: orange;
      color: white;
      font-weight: bold;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    #shameButton {
      background-color: crimson;
      color: white;
      font-weight: bold;
      margin-top: 10px;
    }
    #qr-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: black;
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #qr-reader {
      width: 90%;
      max-width: 400px;
    }
    #scan-instruction {
      color: white;
      margin-bottom: 20px;
      font-size: 18px;
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 30px;
      color: white;
      background: none;
      border: none;
      cursor: pointer;
    }
    #target-square {
      border: 4px solid white;
      width: 250px;
      height: 250px;
      position: absolute;
    }
    #player-container {
      position: relative;
      width: 320px;
      height: 180px;
      margin: 20px auto;
      overflow: hidden;
    }
    #player iframe {
      width: 100%;
      height: 100%;
      opacity: 0.6;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      backdrop-filter: blur(15px);
      background-color: rgba(0, 0, 0, 0.4);
      z-index: 10;
    }
    #progress-bar {
      width: 80%;
      height: 10px;
      background-color: #ccc;
      border-radius: 5px;
      overflow: hidden;
      margin: 20px auto;
    }
    #progress {
      width: 0%;
      height: 100%;
      background-color: #4CAF50;
      transition: width 0.1s linear;
    }
    #songInfo {
      margin-top: 15px;
      font-size: 18px;
      color: #333;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <button id="qr-button" onclick="openQRScanner()">üì∑ QR k√≥d beolvas√°sa</button>

  <div id="qr-overlay">
    <button class="close-btn" onclick="closeQRScanner()">‚úñ</button>
    <div id="scan-instruction">Olvasd be a QR k√≥dot:</div>
    <div id="target-square"></div>
    <div id="qr-reader"></div>
  </div>

  <h1>BeatRush üéµ</h1>

  <input type="text" id="youtubeLink" placeholder="Illeszd be a YouTube linket...">
  <br>

  <button id="loadButton" onclick="loadVideo()">Bet√∂lt√©s</button>

  <h3>üéµ 0 m√°sodpercr≈ël indul√≥ gombok:</h3>
  <div class="button-group">
    <button onclick="playSegmentFromStart(1)">1 mp</button>
    <button onclick="playSegmentFromStart(3)">3 mp</button>
    <button onclick="playSegmentFromStart(5)">5 mp</button>
  </div>

  <h3>üéµ 15 m√°sodpercr≈ël indul√≥ gombok:</h3>
  <div class="button-group">
    <button onclick="playSegment(1)">1 mp</button>
    <button onclick="playSegment(3)">3 mp</button>
    <button onclick="playSegment(5)">5 mp</button>
    <button onclick="playFullTrack()">Full Track</button>
  </div>

  <div id="player-container">
    <div id="player"></div>
    <div id="overlay"></div>
  </div>

  <div id="progress-bar">
    <div id="progress"></div>
  </div>

  <button id="shameButton" onclick="shameMode()">Sz√©gyen! üôà</button>

  <div id="songInfo"></div>

  <!-- QR k√≥d olvas√≥ k√∂nyvt√°r -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let player;
    let videoId = '';
    let interval;
    let qrScanner;

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '180',
        width: '320',
        videoId: '',
        events: {
          'onReady': onPlayerReady
        }
      });
    }

    function onPlayerReady(event) {
      console.log("YouTube player ready");
    }

    function extractVideoId(url) {
      const regex = /[?&]v=([^&#]*)/;
      const match = url.match(regex);
      if (match && match[1]) {
        return match[1];
      } else {
        const parts = url.split("/");
        return parts[parts.length - 1];
      }
    }

    function loadVideo() {
      const link = document.getElementById('youtubeLink').value;
      videoId = extractVideoId(link);
      player.loadVideoById(videoId);
      player.stopVideo();
      document.getElementById('overlay').style.display = "block"; 
      document.getElementById('songInfo').innerText = "";
    }

    function playSegment(seconds) {
      if (player && videoId) {
        player.mute();
        player.playVideo();
        setTimeout(() => {
          player.seekTo(15);
          player.unMute();
          animateProgress(seconds);
          setTimeout(() => {
            player.stopVideo();
            resetProgress();
          }, seconds * 1000);
        }, 500);
      }
    }

    function playSegmentFromStart(seconds) {
      if (player && videoId) {
        player.unMute();
        player.seekTo(0);
        player.playVideo();
        animateProgress(seconds);
        setTimeout(() => {
          player.stopVideo();
          resetProgress();
        }, seconds * 1000);
      }
    }

    function playFullTrack() {
      if (player && videoId) {
        player.unMute();
        player.seekTo(0);
        player.playVideo();
      }
    }

    function shameMode() {
      if (player && videoId) {
        document.getElementById('overlay').style.display = "none";
        player.unMute();
        player.seekTo(0);
        player.playVideo();

        const videoData = player.getVideoData();
        let title = videoData.title || "Ismeretlen sz√°m";
        let author = videoData.author || "";

        let artist = "Ismeretlen el≈ëad√≥";
        let song = title;

        if (title.includes(" - ")) {
          const parts = title.split(" - ");
          artist = parts[0].trim();
          song = parts.slice(1).join("-").trim();
        } else if (author !== "") {
          artist = author;
        }

        document.getElementById('songInfo').innerHTML = `
          üéµ <b>El≈ëad√≥:</b> ${artist} <br>
          üéµ <b>C√≠m:</b> ${song}
        `;
      }
    }

    function openQRScanner() {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(function(stream) {
          document.getElementById('qr-overlay').style.display = "flex";
          qrScanner = new Html5Qrcode("qr-reader");
          qrScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            qrCodeMessage => {
              document.getElementById('youtubeLink').value = qrCodeMessage;
              closeQRScanner();
            },
            errorMessage => {
              console.log(`QR error: ${errorMessage}`);
            }
          ).catch(err => {
            console.error(`Kamera hiba: ${err}`);
          });
        })
        .catch(function(err) {
          alert("A kamera el√©r√©s√©hez enged√©ly sz√ºks√©ges! üòî K√©rlek enged√©lyezd a kamer√°t a b√∂ng√©sz≈ëben.");
          console.error("getUserMedia hiba:", err);
        });
    }

    function closeQRScanner() {
      if (qrScanner) {
        qrScanner.stop().then(() => {
          qrScanner.clear();
          qrScanner = null;
          document.getElementById('qr-overlay').style.display = "none";
        });
      } else {
        document.getElementById('qr-overlay').style.display = "none";
      }
    }

    function animateProgress(duration) {
      resetProgress();
      const progress = document.getElementById('progress');
      let width = 0;
      interval = setInterval(() => {
        width += 100 / (duration * 10);
        if (width >= 100) {
          width = 100;
          clearInterval(interval);
        }
        progress.style.width = width + "%";
      }, 100);
    }

    function resetProgress() {
      clearInterval(interval);
      document.getElementById('progress').style.width = "0%";
    }
  </script>

</body>
</html>
